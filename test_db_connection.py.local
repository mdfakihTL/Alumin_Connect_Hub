#!/usr/bin/env python3
"""
Test database connection script
"""
import asyncio
import sys
import os
from pathlib import Path

# Add project root to path
sys.path.insert(0, str(Path(__file__).parent))

try:
    from dotenv import load_dotenv
    load_dotenv()
except ImportError:
    print("‚ö†Ô∏è  python-dotenv not installed. Install with: pip install python-dotenv")
    print("   Trying to read .env manually...")
    # Manual .env reading
    env_file = Path('.env')
    if env_file.exists():
        with open(env_file) as f:
            for line in f:
                if '=' in line and not line.strip().startswith('#'):
                    key, value = line.strip().split('=', 1)
                    os.environ[key] = value

async def test_connection():
    """Test database connection"""
    try:
        from app.db.session import async_engine
        from sqlalchemy import text
        
        print("üîÑ Testing database connection...")
        print(f"   Database URL: {os.getenv('DATABASE_URL', 'NOT SET')[:50]}...")
        
        async with async_engine.connect() as conn:
            result = await conn.execute(text("SELECT version();"))
            version = result.scalar()
            print(f"‚úÖ Connection successful!")
            print(f"   PostgreSQL version: {version[:50]}...")
            return True
            
    except Exception as e:
        print(f"‚ùå Connection failed: {str(e)}")
        print("\nüí° Troubleshooting:")
        print("   1. Check your DATABASE_URL in .env")
        print("   2. Verify your Neon connection string")
        print("   3. Ensure SSL is enabled (?sslmode=require)")
        print("   4. Check if database exists in Neon dashboard")
        return False

def test_sync_connection():
    """Test sync database connection (for Alembic)"""
    try:
        from app.db.session import sync_engine
        from sqlalchemy import text
        
        print("\nüîÑ Testing sync database connection (for migrations)...")
        print(f"   Database URL: {os.getenv('DATABASE_URL_SYNC', 'NOT SET')[:50]}...")
        
        with sync_engine.connect() as conn:
            result = conn.execute(text("SELECT version();"))
            version = result.scalar()
            print(f"‚úÖ Sync connection successful!")
            print(f"   PostgreSQL version: {version[:50]}...")
            return True
            
    except Exception as e:
        print(f"‚ùå Sync connection failed: {str(e)}")
        print("\nüí° Troubleshooting:")
        print("   1. Check your DATABASE_URL_SYNC in .env")
        print("   2. Ensure it uses postgresql:// (not postgresql+asyncpg://)")
        return False

if __name__ == "__main__":
    print("=" * 60)
    print("Database Connection Test")
    print("=" * 60)
    
    # Check environment variables
    db_url = os.getenv('DATABASE_URL')
    db_sync = os.getenv('DATABASE_URL_SYNC')
    
    if not db_url:
        print("‚ùå DATABASE_URL not set in .env")
        sys.exit(1)
    
    if not db_sync:
        print("‚ùå DATABASE_URL_SYNC not set in .env")
        sys.exit(1)
    
    # Test async connection
    async_result = asyncio.run(test_connection())
    
    # Test sync connection
    sync_result = test_sync_connection()
    
    print("\n" + "=" * 60)
    if async_result and sync_result:
        print("‚úÖ All connections successful! You're ready to run migrations.")
        print("\nNext steps:")
        print("  1. Run: alembic upgrade head")
        print("  2. Run: python -m app.db.init_db")
        print("  3. Start server: uvicorn app.main:app --reload")
    else:
        print("‚ùå Some connections failed. Please fix the issues above.")
        sys.exit(1)

